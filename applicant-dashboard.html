<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applicant Dashboard - School Admission Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- For PDF generation (same as admin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dashboard-container { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-backdrop { z-index: 50; }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-Submitted { background-color: #e0e7ff; color: #4338ca; } /* Indigo-100 / Indigo-700 */
        .status-Under-Review { background-color: #fef3c7; color: #b45309; } /* Amber-100 / Amber-700 */
        .status-Accepted { background-color: #d1fae5; color: #065f46; } /* Green-100 / Green-700 */
        .status-Rejected { background-color: #fee2e2; color: #991b1b; } /* Red-100 / Red-700 */
        .status-Paid { background-color: #dbeafe; color: #1e40af; } /* Blue-100 / Blue-700 */
        .status-Payment-Pending { background-color: #fce7f3; color: #be185d; } /* Pink-100 / Pink-700 */
        .status-Payment-Submitted { background-color: #e0f2fe; color: #0369a1; } /* Light Blue-100 / Light Blue-700 */
        .status-Payment-Approved { background-color: #ecfdf5; color: #047857; } /* Emerald-100 / Emerald-700 */
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <div class="max-w-4xl mx-auto bg-white p-8 md:p-12 rounded-2xl dashboard-container">
            
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Applicant Dashboard</h1>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-md">Logout</button>
            </div>

            <div id="loading-state" class="text-center p-8">
                <div class="flex justify-center items-center"><svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                <p class="mt-4 text-gray-600">Loading your application details...</p>
            </div>

            <div id="application-details" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Application Number:</p>
                        <p id="app-no" class="text-lg font-semibold text-gray-800"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Full Name:</p>
                        <p id="full-name" class="text-lg font-semibold text-gray-800"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Email:</p>
                        <p id="email" class="text-lg font-semibold text-gray-800"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Phone:</p>
                        <p id="phone" class="text-lg font-semibold text-gray-800"></p>
                    </div>
                    <div class="md:col-span-2">
                        <p class="text-sm font-medium text-gray-700">Current Status:</p>
                        <span id="status-badge" class="status-badge"></span>
                    </div>
                </div>

                <!-- Payment Section -->
                <div id="payment-section" class="bg-blue-50 p-6 rounded-lg mb-8 hidden">
                    <h2 class="text-xl font-bold text-blue-800 mb-4">Payment Information</h2>
                    <p class="text-gray-700 mb-4">Your application has been accepted! Please make the payment to confirm your admission.</p>
                    <p class="mb-4">
                        <strong class="text-blue-700">Payment Link:</strong> 
                        <a id="payment-link" href="#" target="_blank" class="text-blue-600 hover:underline font-medium">Click here to pay</a>
                    </p>
                    
                    <div class="mb-4">
                        <label for="payment-screenshot" class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Screenshot:</label>
                        <input type="file" id="payment-screenshot" accept="image/*" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100"/>
                        <p class="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG. Max file size: 5MB.</p>
                        <div id="screenshot-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium text-gray-700 mb-2">Current/Uploaded Screenshot:</p>
                            <img id="screenshot-preview" src="" alt="Payment Screenshot" class="max-w-xs h-auto rounded-lg shadow-md border border-gray-200" onerror="this.style.display='none'">
                        </div>
                    </div>
                    <button id="upload-screenshot-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <span id="upload-button-text">Upload Screenshot</span>
                        <svg id="upload-button-spinner" class="animate-spin h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p id="payment-status-message" class="mt-4 text-sm font-medium text-blue-700 hidden"></p>
                </div>

                <!-- Download Application Section -->
                <div id="download-section" class="bg-green-50 p-6 rounded-lg hidden">
                    <h2 class="text-xl font-bold text-green-800 mb-4">Admission Confirmed!</h2>
                    <p class="text-gray-700 mb-4">Congratulations! Your admission has been confirmed. You can now download your official application document.</p>
                    <button id="download-application-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                        Download Application (PDF)
                    </button>
                </div>

                 <!-- Message for other statuses -->
                <div id="other-status-message" class="bg-gray-100 p-6 rounded-lg hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Application Update</h2>
                    <p id="status-info-text" class="text-gray-700"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Message Box -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 modal-backdrop hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Notification</h3>
            <p class="text-gray-600 mb-6" id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCzlbVpsLSQECmVUs5wyaXKy-fz8nfhjkM", // Replace with your actual API Key
            authDomain: "schooladmsn.firebaseapp.com",
            projectId: "schooladmsn",
            storageBucket: "schooladmsn.firebasestorage.app",
            messagingSenderId: "355479237462",
            appId: "1:355479237462:web:8eaba019c00ad8684d5cf7",
            measurementId: "G-LJW1ZQTGSV"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const loadingState = document.getElementById('loading-state');
        const applicationDetails = document.getElementById('application-details');
        const appNoElem = document.getElementById('app-no');
        const fullNameElem = document.getElementById('full-name');
        const emailElem = document.getElementById('email');
        const phoneElem = document.getElementById('phone');
        const statusBadge = document.getElementById('status-badge');
        const logoutBtn = document.getElementById('logout-btn');
        const paymentSection = document.getElementById('payment-section');
        const paymentLink = document.getElementById('payment-link');
        const paymentScreenshotInput = document.getElementById('payment-screenshot');
        const uploadScreenshotBtn = document.getElementById('upload-screenshot-btn');
        const uploadButtonText = document.getElementById('upload-button-text');
        const uploadButtonSpinner = document.getElementById('upload-button-spinner');
        const screenshotPreviewContainer = document.getElementById('screenshot-preview-container');
        const screenshotPreview = document.getElementById('screenshot-preview');
        const paymentStatusMessage = document.getElementById('payment-status-message');
        const downloadSection = document.getElementById('download-section');
        const downloadApplicationBtn = document.getElementById('download-application-btn');
        const otherStatusMessage = document.getElementById('other-status-message');
        const statusInfoText = document.getElementById('status-info-text');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        let userApplication = null; // Store the current user's application data
        let userApplicationDocId = null; // Store the document ID of the user's application

        // --- Authentication Check and Data Fetching ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // User is not logged in, redirect to login page
                window.location.href = 'applicant-login.html';
            } else {
                // User is logged in, fetch their application
                await fetchUserApplication(user.email);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'applicant-login.html';
            } catch (error) {
                console.error("Error logging out: ", error);
                showCustomAlert("Failed to log out. Please try again.");
            }
        });

        async function fetchUserApplication(userEmail) {
            loadingState.classList.remove('hidden');
            applicationDetails.classList.add('hidden');
            paymentSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            otherStatusMessage.classList.add('hidden');

            try {
                const q = query(collection(db, "applications"), where("email", "==", userEmail));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showCustomAlert("No application found for your email. Please ensure you have submitted an application.");
                    // Optionally, redirect to the application form
                    // window.location.href = 'index.html';
                    return;
                }

                // Listen for real-time updates to the application
                userApplicationDocId = querySnapshot.docs[0].id;
                onSnapshot(doc(db, "applications", userApplicationDocId), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        userApplication = { id: docSnapshot.id, ...docSnapshot.data() };
                        renderApplicationDetails();
                    } else {
                        showCustomAlert("Your application could not be found or has been removed.");
                        // Optionally, log out or redirect
                        signOut(auth);
                    }
                    loadingState.classList.add('hidden');
                    applicationDetails.classList.remove('hidden');
                });

            } catch (error) {
                console.error("Error fetching user application: ", error);
                showCustomAlert("Error loading your application. Please try again.");
                loadingState.classList.add('hidden');
            }
        }

        function renderApplicationDetails() {
            if (!userApplication) return;

            appNoElem.textContent = userApplication.applicationNo;
            fullNameElem.textContent = userApplication.fullName;
            emailElem.textContent = userApplication.email;
            phoneElem.textContent = userApplication.phone;

            // Update status badge
            statusBadge.textContent = userApplication.status;
            statusBadge.className = `status-badge status-${userApplication.status.replace(/ /g, '-')}`;

            // Reset section visibility
            paymentSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            otherStatusMessage.classList.add('hidden');
            paymentStatusMessage.classList.add('hidden');
            screenshotPreviewContainer.classList.add('hidden');
            screenshotPreview.style.display = 'none'; // Hide image element

            // Logic for displaying sections based on status
            if (userApplication.status === "Accepted") {
                paymentSection.classList.remove('hidden');
                // Set a dummy payment link for now. Replace with actual link.
                paymentLink.href = "https://example.com/pay"; 
                paymentLink.textContent = "Click here to pay (Dummy Link)";

                if (userApplication.paymentScreenshotUrl) {
                    screenshotPreview.src = userApplication.paymentScreenshotUrl;
                    screenshotPreview.style.display = 'block';
                    screenshotPreviewContainer.classList.remove('hidden');
                    paymentStatusMessage.textContent = "Payment screenshot uploaded. Awaiting admin approval.";
                    paymentStatusMessage.classList.remove('hidden');
                    uploadScreenshotBtn.disabled = true; // Disable upload if already uploaded
                    uploadButtonText.textContent = "Screenshot Uploaded";
                } else {
                    uploadScreenshotBtn.disabled = false;
                    uploadButtonText.textContent = "Upload Screenshot";
                }
            } else if (userApplication.status === "Paid" || userApplication.status === "Accepted & Paid") { // Admin marks as "Paid"
                downloadSection.classList.remove('hidden');
                paymentSection.classList.remove('hidden'); // Still show payment section but indicate paid
                paymentLink.href = "#"; // Disable payment link
                paymentLink.textContent = "Payment Confirmed!";
                paymentLink.classList.remove('text-blue-600', 'hover:underline');
                paymentLink.classList.add('text-green-700', 'font-bold');

                if (userApplication.paymentScreenshotUrl) {
                    screenshotPreview.src = userApplication.paymentScreenshotUrl;
                    screenshotPreview.style.display = 'block';
                    screenshotPreviewContainer.classList.remove('hidden');
                }
                paymentStatusMessage.textContent = "Your payment has been successfully approved!";
                paymentStatusMessage.classList.remove('hidden');
                uploadScreenshotBtn.disabled = true;
                uploadButtonText.textContent = "Payment Approved";
            }
            else {
                otherStatusMessage.classList.remove('hidden');
                let message = "";
                switch (userApplication.status) {
                    case "Submitted":
                        message = "Your application has been submitted and is currently under review. Please check back later for updates.";
                        break;
                    case "Under Review":
                        message = "Your application is actively being reviewed by the admissions committee. We will notify you of any changes.";
                        break;
                    case "Rejected":
                        message = "We regret to inform you that your application has been rejected at this time. Please contact the admissions office for more details.";
                        break;
                    default:
                        message = `Your application status is: ${userApplication.status}.`;
                }
                statusInfoText.textContent = message;
            }
        }

        // --- Payment Screenshot Upload ---
        uploadScreenshotBtn.addEventListener('click', async () => {
            const file = paymentScreenshotInput.files[0];
            if (!file) {
                showCustomAlert("Please select a screenshot to upload.");
                return;
            }

            if (!userApplicationDocId) {
                showCustomAlert("Application data not loaded. Please refresh the page.");
                return;
            }

            setUploadLoading(true);

            const storageRef = ref(storage, `payment_screenshots/${userApplicationDocId}_${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Observe state change events such as progress, pause, and resume
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadButtonText.textContent = `Uploading ${progress.toFixed(0)}%`;
                }, 
                (error) => {
                    console.error("Upload error: ", error);
                    showCustomAlert("Failed to upload screenshot. Please try again.");
                    setUploadLoading(false);
                    uploadButtonText.textContent = "Upload Screenshot"; // Reset text on error
                }, 
                async () => {
                    // Handle successful uploads on complete
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        const docRef = doc(db, "applications", userApplicationDocId);
                        await updateDoc(docRef, {
                            paymentScreenshotUrl: downloadURL,
                            status: "Payment Submitted" // Update status after screenshot upload
                        });
                        showCustomAlert("Payment screenshot uploaded successfully! Status updated to 'Payment Submitted'.");
                        // UI will update via onSnapshot listener
                    } catch (error) {
                        console.error("Error updating document with screenshot URL: ", error);
                        showCustomAlert("Failed to save screenshot URL to application. Please contact support.");
                    } finally {
                        setUploadLoading(false);
                        paymentScreenshotInput.value = ''; // Clear file input
                    }
                }
            );
        });

        function setUploadLoading(isLoading) {
            uploadScreenshotBtn.disabled = isLoading;
            if (isLoading) {
                uploadButtonText.classList.add('hidden');
                uploadButtonSpinner.classList.remove('hidden');
            } else {
                uploadButtonText.classList.remove('hidden');
                uploadButtonSpinner.classList.add('hidden');
            }
        }

        // --- Download Application PDF ---
        downloadApplicationBtn.addEventListener('click', () => {
            if (!userApplication) {
                showCustomAlert("Application data not available for download.");
                return;
            }

            const data = userApplication;

            // Create a temporary div to render the application for PDF
            const tempDiv = document.createElement('div');
            tempDiv.style.padding = '20px';
            tempDiv.style.fontFamily = 'Inter, sans-serif';
            tempDiv.style.color = '#333';

            let contentHtml = `
                <h1 style="text-align: center; margin-bottom: 20px; font-size: 28px; font-weight: bold; color: #1f2937;">Admission Application Details</h1>
                <p style="text-align: center; margin-bottom: 30px; font-size: 16px; color: #4a5568;">Official Document - MZR ACADEMY</p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px;">
                    <p><strong>Application No:</strong> ${data.applicationNo}</p>
                    <p><strong>Full Name:</strong> ${data.fullName}</p>
                    <p><strong>Date of Birth:</strong> ${data.dob}</p>
                    <p><strong>Email:</strong> ${data.email}</p>
                    <p><strong>Phone:</strong> ${data.phone}</p>
                    <p style="grid-column: span 2;"><strong>Address:</strong> ${data.address}</p>
                    <p><strong>Last Passed Exam:</strong> ${data.lastPassedExam || 'N/A'}</p>
                    <p><strong>Percentage/CGPA:</strong> ${data.percentageCgpa || 'N/A'}</p>
                    <p><strong>Submitted On:</strong> ${data.submittedAt ? new Date(data.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>
                    <p><strong>Current Status:</strong> <span style="font-weight: bold; color: ${getStatusColor(data.status)};">${data.status}</span></p>
                </div>

                <div style="margin-top: 25px; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px;">
                    <h2 style="font-size: 22px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">Admission & Payment Status</h2>
                    <p style="margin-bottom: 10px;"><strong>Admission Decision:</strong> <span style="font-weight: bold; color: ${getStatusColor(data.status)};">${data.status}</span></p>
            `;

            if (data.status === "Accepted" || data.status === "Paid" || data.status === "Accepted & Paid" || data.status === "Payment Submitted" || data.status === "Payment Approved") {
                contentHtml += `
                    <p style="margin-bottom: 10px;"><strong>Payment Status:</strong> <span style="font-weight: bold; color: ${data.isPaid ? '#047857' : '#be185d'};">${data.isPaid ? 'Paid & Approved' : (data.paymentScreenshotUrl ? 'Screenshot Submitted' : 'Payment Pending')}</span></p>
                `;
                if (data.paymentScreenshotUrl) {
                    contentHtml += `
                        <p style="margin-bottom: 10px;"><strong>Payment Screenshot:</strong></p>
                        <img src="${data.paymentScreenshotUrl}" alt="Payment Proof" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" onerror="this.style.display='none';">
                    `;
                }
            } else {
                contentHtml += `
                    <p style="margin-bottom: 10px; color: #6b7280;">Payment information not applicable for current status.</p>
                `;
            }

            contentHtml += `
                </div>

                <div style="margin-top: 30px; text-align: center; font-size: 14px; color: #6b7280;">
                    <p>This is an automatically generated document. For any discrepancies, please contact the MZR ACADEMY admissions office.</p>
                    <p style="margin-top: 5px;">Generated on: ${new Date().toLocaleString()}</p>
                </div>
            `;
            tempDiv.innerHTML = contentHtml;
            document.body.appendChild(tempDiv); // Temporarily add to DOM for html2pdf

            const opt = {
                margin: 0.5,
                filename: `Application_${data.applicationNo}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().from(tempDiv).set(opt).save().then(() => {
                tempDiv.remove(); // Remove temporary div after PDF generation
            });
        });

        function getStatusColor(status) {
            switch(status) {
                case "Submitted": return "#4338ca"; // Indigo
                case "Under Review": return "#b45309"; // Amber
                case "Accepted": return "#065f46"; // Green
                case "Rejected": return "#991b1b"; // Red
                case "Payment Submitted": return "#0369a1"; // Light Blue
                case "Paid": return "#1e40af"; // Blue
                case "Accepted & Paid": return "#047857"; // Emerald
                case "Payment Approved": return "#047857"; // Emerald
                default: return "#4a5568"; // Gray
            }
        }

        // Custom Alert/Message Box Function (replaces alert())
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
            customAlertModal.classList.add('flex');
        }

        customAlertOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
            customAlertModal.classList.remove('flex');
        });
    </script>
</body>
</html>
