<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MZR School Admission Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-container { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-backdrop { z-index: 50; }
        .file-upload-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .file-upload-preview img {
            width: 4rem; /* 64px */
            height: 4rem; /* 64px */
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .file-upload-preview .file-name {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* gray-700 */
        }
        .file-upload-progress {
            width: 100%;
            background-color: #e0e7ff; /* blue-100 */
            border-radius: 9999px; /* rounded-full */
            height: 0.5rem; /* 8px */
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .file-upload-progress-bar {
            height: 100%;
            background-color: #3b82f6; /* blue-500 */
            width: 0%;
            transition: width 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <div class="max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-2xl form-container">
            
            <div class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Admission Application Form</h1>
                <p class="text-gray-500 mt-3">Please fill out the details below accurately.</p>
            </div>

            <form id="admission-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="fullName" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        <input type="date" id="dob" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phone" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700">Full Address</label>
                        <textarea id="address" rows="3" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                    </div>
                    <!-- Photo Upload Field -->
                    <div class="md:col-span-2">
                        <label for="photoUpload" class="block text-sm font-medium text-gray-700">Upload Passport Size Photo <span class="text-red-500">*</span></label>
                        <input type="file" id="photoUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        <div id="photo-upload-preview" class="file-upload-preview hidden">
                            <img id="photo-preview-img" src="" alt="Photo Preview">
                            <span id="photo-file-name" class="file-name"></span>
                        </div>
                        <div id="photo-upload-progress" class="file-upload-progress hidden">
                            <div id="photo-progress-bar" class="file-upload-progress-bar"></div>
                        </div>
                        <p id="photo-upload-status" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <!-- Document Upload Field -->
                    <div class="md:col-span-2">
                        <label for="documentUpload" class="block text-sm font-medium text-gray-700">Upload Supporting Document (e.g., Marksheet, Certificate) <span class="text-red-500">*</span></label>
                        <input type="file" id="documentUpload" accept=".pdf,.doc,.docx" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        <div id="document-upload-preview" class="file-upload-preview hidden">
                            <svg class="h-10 w-10 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-2 18H6v-2h6v2zm0-4H6v-2h6v2zm-2-4H6v-2h4v2zm3-6V3.5L18.5 9H13z"/></svg>
                            <span id="document-file-name" class="file-name"></span>
                        </div>
                        <div id="document-upload-progress" class="file-upload-progress hidden">
                            <div id="document-progress-bar" class="file-upload-progress-bar"></div>
                        </div>
                        <p id="document-upload-status" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <!-- Academic Fields -->
                    <div>
                        <label for="lastPassedExam" class="block text-sm font-medium text-gray-700">Last Passed Exam <span class="text-red-500">*</span></label>
                        <input type="text" id="lastPassedExam" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 10th Grade, High School Diploma" required>
                    </div>
                    <div>
                        <label for="percentageCgpa" class="block text-sm font-medium text-gray-700">Percentage / CGPA <span class="text-red-500">*</span></label>
                        <input type="text" id="percentageCgpa" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 85% or 9.2 CGPA" required>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-12 rounded-lg hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center mx-auto">
                        <span id="button-text">Submit Application</span>
                        <svg id="button-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
        <div class="text-center mt-6">
            <a href="./status.html" class="text-blue-600 hover:underline">Already applied? Check your application status here.</a>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-2xl font-semibold text-gray-800">Application Submitted!</h3>
            <p class="text-gray-600 mt-3">Your application has been received. Your Application Number is:</p>
            <p id="application-number" class="text-2xl font-bold text-blue-600 my-4 bg-blue-50 py-2 rounded-lg"></p>
            <p class="text-sm text-red-600 font-medium">Please save this number for future reference.</p>
            <button id="modal-close-btn" class="mt-6 w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCzlbVpsLSQECmVUs5wyaXKy-fz8nfhjkM", // Replace with your actual API Key
            authDomain: "schooladmsn.firebaseapp.com",
            projectId: "schooladmsn",
            storageBucket: "schooladmsn.firebasestorage.app",
            messagingSenderId: "355479237462",
            appId: "1:355479237462:web:8eaba019c00ad8684d5cf7",
            measurementId: "G-LJW1ZQTGSV"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const form = document.getElementById('admission-form');
        const submitBtn = document.getElementById('submit-btn');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const successModal = document.getElementById('success-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // File Upload Elements
        const photoUploadInput = document.getElementById('photoUpload');
        const photoUploadPreview = document.getElementById('photo-upload-preview');
        const photoPreviewImg = document.getElementById('photo-preview-img');
        const photoFileNameSpan = document.getElementById('photo-file-name');
        const photoUploadProgress = document.getElementById('photo-upload-progress');
        const photoProgressBar = document.getElementById('photo-progress-bar');
        const photoUploadStatus = document.getElementById('photo-upload-status');

        const documentUploadInput = document.getElementById('documentUpload');
        const documentUploadPreview = document.getElementById('document-upload-preview');
        const documentFileNameSpan = document.getElementById('document-file-name');
        const documentUploadProgress = document.getElementById('document-upload-progress');
        const documentProgressBar = document.getElementById('document-progress-bar');
        const documentUploadStatus = document.getElementById('document-upload-status');

        let uploadedPhotoUrl = null;
        let uploadedDocumentUrl = null;
        let photoUploadTask = null; // To keep track of the upload task
        let documentUploadTask = null; // To keep track of the upload task

        // Function to handle file uploads
        async function uploadFile(file, filePath, progressBarElement, statusElement, previewElement, fileNameSpanElement, previewImgElement = null) {
            if (!file) return null;

            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            // Show progress bar and status
            progressBarElement.style.width = '0%';
            progressBarElement.parentElement.classList.remove('hidden');
            statusElement.textContent = 'Uploading...';
            statusElement.classList.remove('text-red-500', 'text-green-600');
            statusElement.classList.add('text-gray-500');

            // Set file name in preview
            fileNameSpanElement.textContent = file.name;
            previewElement.classList.remove('hidden');

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Observe state change events such as progress, pause, and resume
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBarElement.style.width = `${progress}%`;
                        statusElement.textContent = `Upload is ${progress.toFixed(0)}% done`;
                    }, 
                    (error) => {
                        // Handle unsuccessful uploads
                        console.error("Upload failed:", error);
                        statusElement.textContent = `Upload failed: ${error.message}`;
                        statusElement.classList.remove('text-gray-500');
                        statusElement.classList.add('text-red-500');
                        progressBarElement.parentElement.classList.add('hidden');
                        reject(error);
                    }, 
                    () => {
                        // Handle successful uploads on complete
                        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                            statusElement.textContent = 'Upload complete!';
                            statusElement.classList.remove('text-gray-500');
                            statusElement.classList.add('text-green-600');
                            progressBarElement.parentElement.classList.add('hidden');
                            if (previewImgElement) {
                                previewImgElement.src = downloadURL;
                            }
                            resolve(downloadURL);
                        }).catch(error => {
                            console.error("Error getting download URL:", error);
                            statusElement.textContent = `Error getting URL: ${error.message}`;
                            statusElement.classList.remove('text-gray-500');
                            statusElement.classList.add('text-red-500');
                            progressBarElement.parentElement.classList.add('hidden');
                            reject(error);
                        });
                    }
                );
            });
        }

        // Event listener for photo upload
        photoUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Generate a unique file name for the photo
                const fileName = `photo_${Date.now()}_${file.name}`;
                const filePath = `applications/temp/${fileName}`; // Use a temp path initially, rename on form submit

                try {
                    photoUploadTask = uploadFile(file, filePath, photoProgressBar, photoUploadStatus, photoUploadPreview, photoFileNameSpan, photoPreviewImg);
                    uploadedPhotoUrl = await photoUploadTask;
                } catch (error) {
                    uploadedPhotoUrl = null;
                }
            } else {
                uploadedPhotoUrl = null;
                photoUploadPreview.classList.add('hidden');
                photoUploadProgress.classList.add('hidden');
                photoUploadStatus.textContent = '';
            }
        });

        // Event listener for document upload
        documentUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Generate a unique file name for the document
                const fileName = `document_${Date.now()}_${file.name}`;
                const filePath = `applications/temp/${fileName}`; // Use a temp path initially, rename on form submit

                try {
                    documentUploadTask = uploadFile(file, filePath, documentProgressBar, documentUploadStatus, documentUploadPreview, documentFileNameSpan);
                    uploadedDocumentUrl = await documentUploadTask;
                } catch (error) {
                    uploadedDocumentUrl = null;
                }
            } else {
                uploadedDocumentUrl = null;
                documentUploadPreview.classList.add('hidden');
                documentUploadProgress.classList.add('hidden');
                documentUploadStatus.textContent = '';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            // Basic validation for file uploads
            if (!uploadedPhotoUrl) {
                showCustomAlert("Please upload your passport size photo.");
                setLoading(false);
                return;
            }
            if (!uploadedDocumentUrl) {
                showCustomAlert("Please upload your supporting document.");
                setLoading(false);
                return;
            }

            // Generate a unique application number
            const applicationNo = `SCHL${Date.now()}`;

            try {
                // Get form data
                const applicationData = {
                    fullName: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    lastPassedExam: document.getElementById('lastPassedExam').value,
                    percentageCgpa: document.getElementById('percentageCgpa').value,
                    photoUrl: uploadedPhotoUrl, // Use the uploaded photo URL
                    documentUrl: uploadedDocumentUrl, // Use the uploaded document URL
                    applicationNo: applicationNo,
                    status: "Submitted", // Initial status
                    submittedAt: serverTimestamp()
                };

                // Add a new document with a generated ID to the "applications" collection
                await addDoc(collection(db, "applications"), applicationData);
                
                // Show success message
                document.getElementById('application-number').textContent = applicationNo;
                successModal.classList.remove('hidden');
                successModal.classList.add('flex');

                // Optionally, you might want to move the files in storage to a permanent folder
                // based on the applicationNo, but for simplicity, we're keeping them in 'applications/temp'
                // and relying on the unique timestamp in the filename. If you need to organize by applicationNo,
                // you'd re-upload or use Firebase Cloud Functions to move them.
                // For this example, the initial upload path includes 'temp' but is effectively permanent due to unique filename.

            } catch (error) {
                console.error("Error adding document: ", error);
                showCustomAlert("There was an error submitting your application. Please try again.");
            } finally {
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        }

        modalCloseBtn.addEventListener('click', () => {
            successModal.classList.add('hidden');
            successModal.classList.remove('flex');
            form.reset();
            // Reset file upload previews and status
            photoUploadInput.value = '';
            documentUploadInput.value = '';
            uploadedPhotoUrl = null;
            uploadedDocumentUrl = null;
            photoUploadPreview.classList.add('hidden');
            photoUploadProgress.classList.add('hidden');
            photoUploadStatus.textContent = '';
            documentUploadPreview.classList.add('hidden');
            documentUploadProgress.classList.add('hidden');
            documentUploadStatus.textContent = '';
        });

        // Custom Alert/Message Box Function (replaces alert())
        function showCustomAlert(message) {
            const existingAlert = document.getElementById('custom-alert-modal');
            if (existingAlert) existingAlert.remove();

            const alertModal = document.createElement('div');
            alertModal.id = 'custom-alert-modal';
            alertModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 modal-backdrop';
            alertModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Notification</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                </div>
            `;
            document.body.appendChild(alertModal);

            document.getElementById('custom-alert-ok-btn').addEventListener('click', () => {
                alertModal.remove();
            });
        }
    </script>
</body>
</html>
