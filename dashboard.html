<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard | Apex School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-slate-100">
    <div id="app-container">
        <!-- Main content will be rendered here -->
    </div>
    <div id="pdf-generator-container" class="fixed top-0 left-[-9999px] z-0"></div>

    <script type="module">
        import { firebaseConfig } from './firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appContainer = document.getElementById('app-container');
        let currentApplicationData = null;

        // --- TEMPLATES ---
        const mainLayoutTemplate = (content, user) => `
            <div class="min-h-screen bg-slate-50">
                <header class="bg-white shadow-sm sticky top-0 z-10 border-b">
                    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="shield-check" class="w-9 h-9 text-indigo-600"></i>
                            <span class="text-xl font-bold text-gray-800">Apex School Dashboard</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600 hidden sm:block">${user.email}</span>
                            <button id="logout-btn" class="flex items-center text-sm font-medium text-red-500 hover:text-red-700 bg-red-100 px-3 py-2 rounded-md transition-colors">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>Logout
                            </button>
                        </div>
                    </nav>
                </header>
                <main id="main-content" class="container mx-auto p-4 md:p-8">${content}</main>
            </div>`;
        
        const printableApplicationTemplate = (application) => {
            if (!application || !application.formData) return '';
            const { formData, applicationId, status, submittedAt } = application;

            const getStatusChip = (status) => {
                const colors = {
                    'Accepted': 'background-color: #10B981; color: white;',
                    'Rejected': 'background-color: #EF4444; color: white;',
                    'Submitted': 'background-color: #F59E0B; color: white;',
                };
                return `<span style="padding: 4px 12px; border-radius: 9999px; font-size: 14px; font-weight: 600; ${colors[status] || ''}">${status}</span>`;
            };

            const submittedDate = submittedAt ? new Date(submittedAt.seconds * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';

            return `
            <div style="width: 210mm; min-height: 297mm; padding: 40px; background-color: white; font-family: 'Inter', sans-serif; color: #1F2937;">
                <header style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 24px; border-bottom: 2px solid #4F46E5;">
                    <div>
                        <h1 style="font-size: 36px; font-weight: 800; color: #4338CA;">Apex International School</h1>
                        <p style="color: #6B7280;">Admission Application Form</p>
                    </div>
                     <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </header>

                <section style="margin-top: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; border-bottom: 1px solid #D1D5DB; padding-bottom: 8px; margin-bottom: 16px;">Application Summary</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px 48px;">
                        <div><strong style="color: #4B5563;">Application ID:</strong> ${applicationId}</div>
                        <div><strong style="color: #4B5563;">Status:</strong> ${getStatusChip(status)}</div>
                        <div><strong style="color: #4B5563;">Submitted On:</strong> ${submittedDate}</div>
                    </div>
                </section>

                <section style="margin-top: 32px;">
                     <h2 style="font-size: 20px; font-weight: 600; border-bottom: 1px solid #D1D5DB; padding-bottom: 8px; margin-bottom: 16px;">Student Information</h2>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px 48px;">
                         <div><strong style="color: #4B5563;">Full Name:</strong> ${formData.fullName || 'N/A'}</div>
                         <div><strong style="color: #4B5563;">Date of Birth:</strong> ${formData.dob || 'N/A'}</div>
                         <div><strong style="color: #4B5563;">Gender:</strong> ${formData.gender || 'N/A'}</div>
                     </div>
                </section>
                
                <footer style="margin-top: 48px; padding-top: 24px; border-top: 1px solid #E5E7EB; text-align: center; font-size: 12px; color: #9CA3AF;">
                    <p>This is a system-generated document. Â© Apex International School. All rights reserved.</p>
                </footer>
            </div>
            `;
        };

        const studentDashboardContent = (application) => {
            if (application) {
                const statusInfo = {
                    'Submitted': { icon: 'mail-check', color: 'blue', text: 'Your application has been submitted and is currently under review. We will notify you of any updates.' },
                    'Accepted': { icon: 'party-popper', color: 'green', text: 'Congratulations! Your application has been accepted. Welcome to Apex International School!' },
                    'Rejected': { icon: 'file-warning', color: 'red', text: 'We regret to inform you that your application has not been successful at this time.' },
                }[application.status];
                
                return `
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-${statusInfo.color}-200">
                        <div class="flex items-center">
                            <div class="mr-5 p-4 rounded-full bg-gradient-to-br from-${statusInfo.color}-400 to-${statusInfo.color}-600 text-white shadow-lg">
                               <i data-lucide="${statusInfo.icon}" class="w-8 h-8"></i>
                           </div>
                           <div>
                               <p class="text-sm font-medium text-gray-500">Application Status</p>
                               <h2 class="text-2xl font-bold text-gray-900">${application.status}</h2>
                               <p class="mt-2 text-gray-600">${statusInfo.text}</p>
                           </div>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Application Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                            <p><strong class="font-medium text-gray-900">Applicant Name:</strong> ${application.formData.fullName || 'N/A'}</p>
                            <p><strong class="font-medium text-gray-900">Application ID:</strong> ${application.applicationId || 'N/A'}</p>
                            <p><strong class="font-medium text-gray-900">Date of Birth:</strong> ${application.formData.dob || 'N/A'}</p>
                            <p><strong class="font-medium text-gray-900">Submitted On:</strong> ${application.submittedAt ? new Date(application.submittedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        <div class="mt-6 flex justify-end">
                             <button id="download-pdf-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-5 rounded-md hover:opacity-90 flex items-center shadow-md disabled:opacity-70">
                                 <i data-lucide="download" class="w-4 h-4 mr-2"></i> Download Application PDF
                             </button>
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center border-2 border-dashed">
                    <i data-lucide="file-plus-2" class="w-16 h-16 text-indigo-400 mx-auto"></i>
                    <h3 class="mt-4 text-xl font-semibold text-gray-800">Ready to Apply?</h3>
                    <p class="mt-2 text-gray-600">You haven't submitted an application yet. Get started now!</p>
                    <button onclick="window.location.href='/form.html'" class="mt-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-8 rounded-lg hover:opacity-90 transition-opacity shadow-lg">
                        Fill Application Form
                    </button>
                </div>`;
            }
        };


        // --- LOGIC ---
        const renderDashboard = (user, application) => {
            currentApplicationData = application;
            const content = studentDashboardContent(application);
            appContainer.innerHTML = mainLayoutTemplate(content, user);
            lucide.createIcons();
            attachListeners();
        };

        const attachListeners = () => {
            document.getElementById('logout-btn')?.addEventListener('click', () => signOut(auth));
            document.getElementById('download-pdf-btn')?.addEventListener('click', () => handleDownloadPdf(currentApplicationData));
        };
        
        const handleDownloadPdf = async (application) => {
            if (!application) return;

            const downloadBtn = document.getElementById('download-pdf-btn');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>Generating...</div>`;
            downloadBtn.disabled = true;

            const container = document.getElementById('pdf-generator-container');
            container.innerHTML = printableApplicationTemplate(application);

            try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(container.firstElementChild, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                pdf.save(`Application-${application.applicationId}.pdf`);
            } catch (error) {
                console.error("PDF Generation Error: ", error);
                alert("Sorry, we couldn't generate the PDF. Please try again.");
            } finally {
                container.innerHTML = '';
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        };

        // --- AUTH CHECK & DATA FETCHING ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, listen for application updates.
                onSnapshot(doc(db, "applications", user.uid), (docSnap) => {
                    const application = docSnap.exists() ? docSnap.data() : null;
                    renderDashboard(user, application);
                });
            } else {
                // No user is signed in, redirect to login page.
                window.location.href = '/index.html';
            }
        });
    </script>
</body>
</html>

