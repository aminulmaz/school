<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Admission Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .modal-overlay { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Admin Dashboard Layout, Table, Modals -->
    <div id="admin-panel" class="hidden">
        <div class="relative flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <div class="flex flex-col w-64 bg-gray-800">
                <div class="flex items-center h-16 flex-shrink-0 px-4 bg-blue-800 text-white">
                    <img src="media/auslogo.png" alt="Logo" class="h-10 w-auto">
                    <span class="ml-3 font-semibold">Admissions Admin</span>
                </div>
                <div class="flex-1 flex flex-col overflow-y-auto">
                     <nav class="flex-1 px-2 py-4 space-y-1">
                        <a href="#" class="bg-gray-900 text-white group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <i data-lucide="inbox" class="mr-3 h-6 w-6"></i>
                            Applications
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main content -->
            <div class="flex flex-col w-0 flex-1 overflow-hidden">
                <header class="relative z-10 flex-shrink-0 flex h-16 bg-white shadow">
                    <div class="flex-1 px-4 flex justify-between">
                        <div class="flex items-center">
                            <h1 class="text-2xl font-bold text-gray-800">Received Applications</h1>
                        </div>
                        <div class="ml-4 flex items-center md:ml-6">
                            <button id="logout-btn" class="btn bg-red-600 text-white hover:bg-red-700">Logout</button>
                        </div>
                    </div>
                </header>

                <main class="flex-1 relative overflow-y-auto focus:outline-none p-6">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg p-6"><p class="text-lg font-semibold">Total Applications</p><p id="total-apps" class="text-4xl font-bold">0</p></div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl shadow-lg p-6"><p class="text-lg font-semibold">Pending Review</p><p id="pending-apps" class="text-4xl font-bold">0</p></div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl shadow-lg p-6"><p class="text-lg font-semibold">Accepted</p><p id="accepted-apps" class="text-4xl font-bold">0</p></div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl shadow-lg p-6"><p class="text-lg font-semibold">Rejected</p><p id="rejected-apps" class="text-4xl font-bold">0</p></div>
                    </div>
                    
                    <!-- Applications Table -->
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                         <div class="p-4 border-b">
                            <input type="text" id="search-input" class="form-input" placeholder="Search by name or application ID...">
                         </div>
                         <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Application ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Applicant Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Course</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="applications-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Application View Modal -->
    <div id="view-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-2xl font-bold text-gray-900">Application Details</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div id="modal-content" class="mt-4 max-h-[75vh] overflow-y-auto p-4"></div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="download-pdf-btn" class="btn bg-gray-600 text-white hover:bg-gray-700">Download PDF</button>
                <button id="reject-btn" class="btn bg-red-600 text-white hover:bg-red-700">Reject</button>
                <button id="accept-btn" class="btn bg-green-600 text-white hover:bg-green-700">Accept</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const adminPanel = document.getElementById('admin-panel');
        const logoutBtn = document.getElementById('logout-btn');
        const applicationsTableBody = document.getElementById('applications-table-body');
        const searchInput = document.getElementById('search-input');
        
        const totalAppsEl = document.getElementById('total-apps');
        const pendingAppsEl = document.getElementById('pending-apps');
        const acceptedAppsEl = document.getElementById('accepted-apps');
        const rejectedAppsEl = document.getElementById('rejected-apps');

        const viewModal = document.getElementById('view-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const acceptBtn = document.getElementById('accept-btn');
        const rejectBtn = document.getElementById('reject-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        let allApplications = [];
        let selectedApplicationId = null;

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDoc = await getDoc(doc(db, "admins", user.uid));
                if (adminDoc.exists()) {
                    adminPanel.classList.remove('hidden');
                    loadApplications();
                } else {
                    alert("You are not authorized to access this page.");
                    window.location.href = 'admin-login.html';
                }
            } else {
                window.location.href = 'admin-login.html';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        function loadApplications() {
            const applicationsRef = collection(db, "applications");
            onSnapshot(applicationsRef, (snapshot) => {
                allApplications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboard(allApplications);
                renderTable(allApplications);
            });
        }

        function updateDashboard(apps) {
            totalAppsEl.textContent = apps.length;
            pendingAppsEl.textContent = apps.filter(app => app.status === 'Pending').length;
            acceptedAppsEl.textContent = apps.filter(app => app.status === 'Accepted').length;
            rejectedAppsEl.textContent = apps.filter(app => app.status === 'Rejected').length;
        }

        function renderTable(apps) {
            applicationsTableBody.innerHTML = apps.map(app => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${app.applicationId}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${app.personalDetails.fullName}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${app.courseDetails.courseName}</td>
                    <td class="px-6 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(app.status)}">${app.status}</span></td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button data-id="${app.id}" class="view-btn text-blue-600 hover:text-blue-900">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Accepted': return 'bg-green-100 text-green-800';
                case 'Rejected': return 'bg-red-100 text-red-800';
                default: return 'bg-yellow-100 text-yellow-800';
            }
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredApps = allApplications.filter(app => 
                app.personalDetails.fullName.toLowerCase().includes(searchTerm) ||
                app.applicationId.toLowerCase().includes(searchTerm)
            );
            renderTable(filteredApps);
        });

        applicationsTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-btn')) {
                selectedApplicationId = e.target.dataset.id;
                const app = allApplications.find(a => a.id === selectedApplicationId);
                openModal(app);
            }
        });
        
        function openModal(app) {
            modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-lg text-blue-800 border-b pb-2 mb-2">Personal Details</h4>
                        <p><strong>Name:</strong> ${app.personalDetails.fullName}</p>
                        <p><strong>Date of Birth:</strong> ${app.personalDetails.dob}</p>
                        <p><strong>Email:</strong> ${app.personalDetails.email}</p>
                        <p><strong>Phone:</strong> ${app.personalDetails.phone}</p>
                        <p><strong>Address:</strong> ${app.personalDetails.address}</p>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg text-blue-800 border-b pb-2 mb-2">Academic Details</h4>
                        <p><strong>Course:</strong> ${app.courseDetails.courseName}</p>
                        <p><strong>10th Board:</strong> ${app.academicDetails.board10}</p>
                        <p><strong>10th Percentage:</strong> ${app.academicDetails.percentage10}%</p>
                        <p><strong>12th Board:</strong> ${app.academicDetails.board12}</p>
                        <p><strong>12th Percentage:</strong> ${app.academicDetails.percentage12}%</p>
                    </div>
                </div>
            `;
            viewModal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => viewModal.classList.add('hidden'));

        async function updateStatus(status) {
            if (!selectedApplicationId) return;
            const appRef = doc(db, "applications", selectedApplicationId);
            await updateDoc(appRef, { status: status });
            viewModal.classList.add('hidden');
        }

        acceptBtn.addEventListener('click', () => updateStatus('Accepted'));
        rejectBtn.addEventListener('click', () => updateStatus('Rejected'));
        
        downloadPdfBtn.addEventListener('click', () => {
             const app = allApplications.find(a => a.id === selectedApplicationId);
             if (!app) return;
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             
             doc.setFontSize(18);
             doc.text("Admission Application Form", 105, 20, null, null, "center");
             doc.setFontSize(12);
             doc.text(`Application ID: ${app.applicationId}`, 14, 30);
             doc.text(`Status: ${app.status}`, 14, 37);

             doc.autoTable({
                startY: 45,
                head: [['Field', 'Details']],
                body: [
                    [{content: 'Personal Details', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [22, 160, 133] }}],
                    ['Full Name', app.personalDetails.fullName],
                    ['Date of Birth', app.personalDetails.dob],
                    ['Email', app.personalDetails.email],
                    ['Phone', app.personalDetails.phone],
                    ['Address', app.personalDetails.address],
                    [{content: 'Academic Details', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [22, 160, 133] }}],
                    ['Course Applied For', app.courseDetails.courseName],
                    ['10th Board', app.academicDetails.board10],
                    ['10th Percentage', `${app.academicDetails.percentage10}%`],
                    ['12th Board', app.academicDetails.board12],
                    ['12th Percentage', `${app.academicDetails.percentage12}%`],
                ]
            });

             doc.save(`Application-${app.applicationId}.pdf`);
        });

        lucide.createIcons();
    </script>
</body>
</html>

